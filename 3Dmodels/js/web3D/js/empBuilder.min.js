var scene3D=[],scene3DFunction=[];EmpScene=function(){this.name="empscene";this.scene=this.controls=this.camera=this.container=this.renderer=null;this.valid=!1;this.stats=this.grid=null;this.sceneBoundingBox=new THREE.Box3;this.sceneBoundingBox.makeEmpty();this.clearColor=3829413;this.clearAlpha=1;this.selected=null;this.raycaster=new THREE.Raycaster;this.actived=!1;this.sceneHelpers=null;this.showSkyboxFlag=this.showGridFlag=this.showAxisFlag=!1;this.clock=this.mixer=this.skyboxCamera=this.skyboxMesh=this.skyboxTexture=this.skyboxScene=null;this.models=[];this.group={};this.bindingDomUI=[];this.cameras=[]};EmpScene.prototype={constructor:EmpScene,setScene:function(a){this.scene.uuid=a.uuid;this.scene.name=a.name;for(this.scene.userData=JSON.parse(JSON.stringify(a.userData));0<a.children.length;)this.addObject(a.children[0])},select:function(a){this.selected!==a&&(this.selected=a)},selectById:function(a){a===this.camera.id?this.select(this.camera):this.select(this.scene.getObjectById(a,!0))},selectByUuid:function(a){var b=this;this.scene.traverse(function(c){c.uuid===a&&b.select(c)})},deselect:function(){this.select(null)},findObjectByName:function(a){if(!this.scene)return null;for(var b in this.scene.children){var c=this.scene.children[b];if(c.name==a)return c}return null},removeObjectByName:function(a){(a=this.findObjectByName(a))&&a.parent.remove(a)},addObject:function(a){this.findObjectByName(a.name)||this.scene.add(a)},addHelper:function(){var a=new THREE.BoxHelper;a.material.depthTest=!1;a.material.transparent=!0;a.name="EMPBOX";a.visible=!1;this.sceneHelpers.add(a);a=new THREE.GridHelper(1E3,10);a.name="EMPGROUND";a.visible=!1;this.sceneHelpers.add(a);a=new THREE.AxisHelper(500);a.name="EMPAXIS";a.visible=!1;this.sceneHelpers.add(a);this.skyboxCamera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,1,1E5);this.skyboxTexture=(new THREE.CubeTextureLoader).load("/templates/js/web3D/js/emp/c_RT.jpg /templates/js/web3D/js/emp/c_LF.jpg /templates/js/web3D/js/emp/c_UP.jpg /templates/js/web3D/js/emp/c_DN.jpg /templates/js/web3D/js/emp/c_BK.jpg /templates/js/web3D/js/emp/c_FR.jpg".split(" "));this.skyboxTexture.format=THREE.RGBFormat;this.skyboxTexture.mapping=THREE.CubeReflectionMapping;a=THREE.ShaderLib.cube;a=new THREE.ShaderMaterial({fragmentShader:a.fragmentShader,vertexShader:a.vertexShader,uniforms:a.uniforms,depthWrite:!1,side:THREE.BackSide});a.uniforms.tCube.value=this.skyboxTexture;this.skyboxMesh=new THREE.Mesh(new THREE.BoxGeometry(1E3,1E3,1E3),a);this.skyboxScene.add(this.skyboxMesh)},showAxis:function(a){this.showAxisFlag=a;for(var b in this.sceneHelpers.children)a=this.sceneHelpers.children[b],"EMPAXIS"==a.name&&(a.visible=this.showAxisFlag)},showGround:function(a){this.showGridFlag=a;for(var b in this.sceneHelpers.children)a=this.sceneHelpers.children[b],"EMPGROUND"==a.name&&(a.visible=this.showGridFlag)},showSkybox:function(a){this.showSkyboxFlag=a;this.skyboxMesh.visible=this.showSkyboxFlag},findObjectByUUID:function(a){if(!this.scene)return null;for(var b in this.scene.children){var c=this.scene.children[b];if(c.uuid==a)return c}return null},setClearColor:function(a,b){this.clearColor=a;this.clearAlpha=b;this.renderer.setClearColor(this.clearColor,this.clearAlpha)},getObjs:function(){if(this.scene)for(var a in this.scene.children){var b=this.scene.children[a];"Mesh"==b.type?(this.modelsmodels[b.uuid]=b,this.models[b.material.uuid]=b.material):this.models[b.uuid]=b}},clearScene:function(){this.camera.position.set(500,250,500);this.camera.lookAt(new THREE.Vector3);for(var a=this.scene.children;0<a.length;)this.removeObject(a[0]);this.geometries={};this.materials={};this.textures={};this.scripts={};this.deselect()},removeHelper:function(a){},removeObject:function(a){if(void 0!==a.parent){var b=this;a.traverse(function(a){b.removeHelper(a)});a.parent.remove(a)}},initScene:function(a){function b(a){a.preventDefault();var b=new THREE.Vector2,e=!!a.touches,k=e?a.touches[0].pageX/EmpGlobalZoom-EmpGlobalLeft-a.currentTarget.offsetLeft:a.offsetX/EmpGlobalZoom,e=e?a.touches[0].pageY/EmpGlobalZoom-EmpGlobalTop-a.currentTarget.offsetTop:a.offsetY/EmpGlobalZoom,k=k/a.currentTarget.clientWidth,e=e/a.currentTarget.clientHeight;b.x=2*k-1;b.y=1-2*e;c.raycaster.setFromCamera(b,c.camera);b=c.raycaster.intersectObjects(c.scene.children);if(0<b.length&&(b=b[0].object)&&"Mesh"==b.type)if("mouseup"==a.type||"touchend"==a.type){if("function"==typeof scene3DFunction[b.name+"_up"])scene3DFunction[b.name+"_up"]()}else if(("mousedown"==a.type||"touchstart"==a.type)&&"function"==typeof scene3DFunction[b.name+"_down"])scene3DFunction[b.name+"_down"]()}this.valid=!1;this.container=document.getElementById(a);if(!this.container)return null;this.clock=new THREE.Clock;this.scene=new THREE.Scene;this.sceneHelpers=new THREE.Scene;this.skyboxScene=new THREE.Scene;this.addHelper();this.camera=new THREE.PerspectiveCamera(50,this.container.offsetWidth/this.container.offsetHeight,.1,1E4);this.controls=new THREE.TrackballControls(this.camera,this.container);isBuilderMode&&(this.controls.enabled=!1);this.createRender(!0);var c=this;this.container.addEventListener("mousedown",b,!1);this.container.addEventListener("mouseup",b,!1);this.container.addEventListener("touchstart",b,!1);this.container.addEventListener("touchend",b,!1)},createRender:function(a){a=new THREE.WebGLRenderer({antialias:a,alpha:!0});a.setClearColor(this.clearColor,this.clearAlpha);a.setPixelRatio(window.devicePixelRatio);a.autoClear=!1;a.autoUpdateScene=!1;a.setSize(this.container.offsetWidth,this.container.offsetHeight);this.container.appendChild(a.domElement);this.renderer=a},createStat:function(){var a=new Stats;a.domElement.style.position="absolute";a.domElement.style.top="0px";this.container.appendChild(a.domElement);this.stats=a},getMaterialByObjName:function(a){return(a=this.findObjectByName(a))&&"Mesh"==a.type?a.material:null},setMaterialByObjName:function(a,b){var c=this.findObjectByName(a);c?"Mesh"==c.type?c.material=b:console.log("obj not mesh",a):console.log("obj not found",a)},showModelByName:function(a,b){for(var c in this.scene.children){var d=this.scene.children[c];"Mesh"!=d.type||a!=d.name&&"EMPALLMODEL"!=a||(d.visible=b)}},showGroupByName:function(a,b){for(var c in this.group[a]){var d=this.group[a][c];"Mesh"==d.type&&(d.visible=b)}},getGroupBoundingBox:function(a){var b=new THREE.Box3;b.makeEmpty();for(var c in this.group[a]){var d=this.group[a][c];"Mesh"==d.type&&(d=d.geometry.boundingBox,b.expandByPoint(d.min),b.expandByPoint(d.max))}return b},loadEmpObjs:function(a,b,c,d,h){function e(a){var b=new THREE.PerspectiveCamera(50,f.container.offsetWidth/f.container.offsetHeight,.1,1E4);void 0!==a&&1<=a.length&&(b.animations=a);f.cameras.push(b);return b}var k=!0;"undefined"!==typeof d&&"undefined"!=typeof d.autoLookAtCenter&&(k=d.autoLookAtCenter);var f=this,g=new THREE.JSONLoader,n=new THREE.JSONAniCameraLoader,t=new THREE.JSONIndexLoader,p=[];this.group[b]=p;var q=0,r=0;t.load(a,function(b){if("undefined"!==typeof b.guidCam)for(var l=0;l<b.guidCam.length;++l){var m=b.guidCam[l],m=a.replace("index.js",m+".js");n.load(m,e)}if("undefined"!==typeof b.guid)for(r=b.guid.length,l=0;l<b.guid.length;++l)m=b.guid[l],m=a.replace("index.js",m+".js"),g.load(m,function(a,b,e){b=b[0];"undefined"!==typeof d&&d.computNormal&&(a.computeFaceNormals(),a.computeVertexNormals());mesh1=new THREE.Mesh(a,b);c||(c="");mesh1.name=c+a.name;mesh1.visible=a.visible;mesh1.applyMatrix(e);mesh1.updateMatrixWorld(!0);a.computeBoundingBox();e=a.boundingBox;e.applyMatrix4(mesh1.matrixWorld);f.sceneBoundingBox.expandByPoint(e.min);f.sceneBoundingBox.expandByPoint(e.max);bbspere=f.sceneBoundingBox.getBoundingSphere();e=f.sceneBoundingBox.center();k&&(f.camera.lookAt(e),f.controls.target.copy(e));f.scene.add(mesh1);p.push(mesh1);"undefined"!==typeof d&&d.autoPlay&&(f.mixer||(f.mixer=new THREE.AnimationMixer(f.scene)),a.animations&&f.mixer.clipAction(a.animations[0],mesh1).setDuration(30*a.animations[0].duration).startAt(0).play());++q;q>=r&&"function"==typeof h&&h()})})},loadObjs:function(a,b,c,d){var h=this;a&&(new THREE.JSONLoader).load(a,function(a,k){var f=b;b||(f=k[0]);var g=f,f=new THREE.Vector3(0,0,0),n=new THREE.Vector3(0,0,0);a.computeVertexNormals();g.side=THREE.DoubleSide;g=new THREE.Mesh(a,g);g.name=c;g.scale.x=g.scale.y=g.scale.z=1;f&&g.position.copy(f);n&&g.rotation.copy(new THREE.Euler(n.x,n.y,n.z,"XYZ"));a.computeBoundingBox();a.computeBoundingSphere();h.addObject(g);f=a.boundingBox;g.updateMatrixWorld(!0);f.applyMatrix4(g.matrixWorld);h.sceneBoundingBox.expandByPoint(f.min);h.sceneBoundingBox.expandByPoint(f.max);d?d(g):h.updateCameraControl(h)})},updateCameraControl:function(a){if(!a.sceneBoundingBox.empty()){var b=a.sceneBoundingBox.getBoundingSphere().center;b.y=b.y;a.controls.target=b;a.controls.object.position.copy(new THREE.Vector3(50,1800,2E3));a.controls.object.up.copy(new THREE.Vector3(0,1,0));a.controls.rotateSpeed=1.5;a.controls.zoomSpeed=1.2;a.controls.panSpeed=1;a.controls.noZoom=!1;a.controls.noPan=!0;a.controls.staticMoving=!0;a.controls.dynamicDampingFactor=.3;a.controls.keys=[65,83,68];a.getObjs()}},resetAniModel:function(){this.mixer||(this.mixer=new THREE.AnimationMixer(this.scene));for(var a in this.scene.children){var b=this.scene.children[a];"Mesh"==b.type&&b.geometry.animations&&this.mixer.clipAction(b.geometry.animations[0],b).stop()}},resetAniCamera:function(a){this.mixer||(this.mixer=new THREE.AnimationMixer(this.scene));for(key in this.cameras){var b=this.cameras[key];b.name==a&&b.animations&&this.mixer.clipAction(b.animations[0],this.controls).stop()}},pauseAniCamera:function(a){this.mixer||(this.mixer=new THREE.AnimationMixer(this.scene));for(key in this.cameras){var b=this.cameras[key];b.name==a&&b.animations&&(this.mixer.clipAction(b.animations[0],this.controls).paused=!0)}},replayAniCamera:function(a){this.mixer||(this.mixer=new THREE.AnimationMixer(this.scene));for(key in this.cameras){var b=this.cameras[key];b.name==a&&b.animations&&(this.mixer.clipAction(b.animations[0],this.controls).paused=!1)}},pauseAniModel:function(){this.mixer||(this.mixer=new THREE.AnimationMixer(this.scene));for(var a in this.scene.children){var b=this.scene.children[a];"Mesh"==b.type&&b.geometry.animations&&(this.mixer.clipAction(b.geometry.animations[0],b).paused=!0)}},replayAniModel:function(){this.mixer||(this.mixer=new THREE.AnimationMixer(this.scene));for(var a in this.scene.children){var b=this.scene.children[a];"Mesh"==b.type&&b.geometry.animations&&(this.mixer.clipAction(b.geometry.animations[0],b).paused=!1)}},playAniModel:function(a){this.mixer||(this.mixer=new THREE.AnimationMixer(this.scene));a=parseFloat(a);isNaN(a)&&(a=1);for(var b in this.scene.children){var c=this.scene.children[b];"Mesh"==c.type&&c.geometry.animations&&this.mixer.clipAction(c.geometry.animations[0],c).setDuration(30*c.geometry.animations[0].duration*a).startAt(null).setLoop(THREE.LOOPONCE,1).play()}},palyAniCamera:function(a,b){var c=parseFloat(b);isNaN(c)&&(c=1);this.mixer||(this.mixer=new THREE.AnimationMixer(this.scene));for(key in this.cameras){var d=this.cameras[key];d.name==a&&d.animations&&this.mixer.clipAction(d.animations[0],this.controls).setDuration(30*d.animations[0].duration*c).startAt(null).setLoop(THREE.LOOPONCE,1).play()}},switchCamera:function(a,b,c,d){this.controls.target=c;this.controls.object.position.copy(d);this.controls.object.up.copy(new THREE.Vector3(0,1,0))},switchToCameraAni:function(a,b,c){this.controls.object.up.copy(new THREE.Vector3(0,1,0));b&&(new TWEEN.Tween(this.controls.object.position)).to(b,c).easing(TWEEN.Easing.Exponential.InOut).start();a&&(new TWEEN.Tween(this.controls.target)).to(a,c).easing(TWEEN.Easing.Exponential.InOut).start()},addBindingDomUI:function(a,b,c){this.bindingDomUI[a]={domID:a,meshName:b,offset:c}},bindDomUI:function(a){var b=this.findObjectByName(a.meshName);if(b&&b.geometry&&(b=b.geometry.boundingBox.center(),b.x+=a.offset.x,b.y+=a.offset.y,b.z+=a.offset.z,b=b.project(this.camera),a=document.getElementById(a.domID))){var c=(1-b.y)*this.container.offsetHeight/2+this.container.offsetTop-a.offsetHeight/2;a.style.left=((b.x+1)*this.container.offsetWidth/2+this.container.offsetLeft-a.offsetWidth/2).toFixed(0)+"px";a.style.top=c.toFixed(0)+"px"}},enable:function(){this.actived=!0;this.reszieScene();this.animate()},disable:function(){this.actived=!1},animate:function(){if(0!=this.actived){var a=this.clock.getDelta();TWEEN.update();this.stats&&this.stats.update();if(this.controls){0==this.controls.screen.width&&0==this.controls.screen.height&&this.controls.handleResize();this.controls.object.up=new THREE.Vector3(0,1,0);var b=new THREE.Sphere;this.sceneBoundingBox.getBoundingSphere(b);var c=new THREE.Vector3;c.subVectors(this.controls.object.position,this.controls.target);c=c.length();this.camera.near=Math.max(.1,c-b.radius);this.camera.far=c+b.radius+1;this.camera.updateProjectionMatrix();this.controls.update()}for(key in this.bindingDomUI)this.bindDomUI(this.bindingDomUI[key]);this.mixer&&this.mixer.update(a);this.render();requestAnimationFrame(animateGlobal)}},render:function(){this.actived&&(this.scene.updateMatrixWorld(),this.skyboxCamera.rotation.copy(this.camera.rotation),this.renderer.clear(),this.renderer.render(this.skyboxScene,this.skyboxCamera),this.renderer.render(this.scene,this.camera),this.renderer.render(this.sceneHelpers,this.camera))},reszieScene:function(){this.controls.handleResize();this.camera.aspect=this.container.offsetWidth/this.container.offsetHeight;this.camera.updateProjectionMatrix();this.skyboxCamera.aspect=window.innerWidth/window.innerHeight;this.skyboxCamera.updateProjectionMatrix();this.renderer.setSize(this.container.offsetWidth,this.container.offsetHeight);this.render()},setSceneSize:function(a,b){this.controls.handleResize();this.camera.aspect=a/b;this.camera.updateProjectionMatrix();this.skyboxCamera.aspect=window.innerWidth/window.innerHeight;this.skyboxCamera.updateProjectionMatrix();this.renderer.setSize(a,b)}};function QueryCamInfo(a){var b="";if(a=scene3D[a]){var b=b+("\u76f8\u673a\u4f4d\u7f6e:"+a.camera.position.x.toFixed(2)+","+a.camera.position.y.toFixed(2)+","+a.camera.position.z.toFixed(2)),b=b+("\r\n\u76ee\u6807\u4f4d\u7f6e:"+a.controls.target.x.toFixed(2)+","+a.controls.target.y.toFixed(2)+","+a.controls.target.z.toFixed(2)),b=b+("\r\n\u6700\u5c0f\u8ddd\u79bb:"+a.controls.minDistance.toFixed(2)),b=b+("\r\n\u6700\u5927\u8ddd\u79bb:"+a.controls.maxDistance.toFixed(2)),c=new THREE.Vector3;c.subVectors(a.controls.object.position,a.controls.target);b+="\r\n\u5f53\u524d\u8ddd\u79bb:"+c.length().toFixed(2)}return b}function QueryMeshInfo(a){var b="";a=a.split(".");if(2!=a.length)return b;var c=scene3D[a[0]];c&&(a=c.findObjectByName(a[1]))&&(c=a.geometry,b+="\u9876\u70b9\u4e2a\u6570:"+c.vertices.length,b+="\r\n\u4e09\u89d2\u9762\u4e2a\u6570:"+c.faces.length,b+="\r\nUV\u901a\u9053\u6570:"+c.faceVertexUvs.length+"\u5c42",b+="\r\n\u5305\u56f4\u5706\u4e2d\u5fc3\u70b9:"+c.boundingSphere.center.x.toFixed(2)+","+c.boundingSphere.center.y.toFixed(2)+","+c.boundingSphere.center.z.toFixed(2)+", \u534a\u5f84"+c.boundingSphere.radius.toFixed(2),b+="\r\n\u5305\u56f4\u76d2:"+c.boundingBox.min.x.toFixed(2)+","+c.boundingBox.min.y.toFixed(2)+","+c.boundingBox.min.z.toFixed(2)+" ~ "+c.boundingBox.max.x.toFixed(2)+","+c.boundingBox.max.y.toFixed(2)+","+c.boundingBox.max.z.toFixed(2),a=a.matrix.elements,b+="\r\n\u77e9\u9635:\r\n  "+a[0]+","+a[1]+","+a[2]+","+a[3]+",\r\n  "+a[4]+","+a[5]+","+a[6]+","+a[7]+",\r\n  "+a[8]+","+a[9]+","+a[10]+","+a[11]+",\r\n  "+a[12]+","+a[13]+","+a[14]+","+a[15]);return b}function _local_replaceColon(a){return a.replace(/:/g,"%3A")}function EMPLyuQuery(a){var b="QueryInfo:";a=a.split(":");if(3!=a.length)return"";"QueryCamInfo"==a[0]?(b+=a[0]+":",b+=_local_replaceColon(QueryCamInfo(a[1])),b+=":"+a[2]):"QueryMeshInfo"==a[0]&&(b+=a[0]+":",b+=_local_replaceColon(QueryMeshInfo(a[1])),b+=":"+a[2]);"function"==typeof MsgBuilder&&MsgBuilder(b)}function dom3dReszie(){for(var a in scene3D)scene3D[a].actived&&scene3D[a].reszieScene()}window.addEventListener("resize",dom3dReszie,!1);function animateGlobal(){for(var a in scene3D)scene3D[a].actived&&scene3D[a].animate()}function create3dScene(a,b,c,d,h){var e=scene3D[a];null==e&&(e=new EmpScene,e.initScene(a),scene3D[a]=e);e.setSceneSize(b,c);e.setClearColor(d,h);return e};